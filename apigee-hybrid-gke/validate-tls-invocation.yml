- name: Validate a proxy invocation
  hosts: localhost

  vars_prompt:
    - name: PROJECT_ID
      prompt: "Please provide the Organization name (PROJECT_ID)?"
      private: no

    - name: PROXY_URI_ENDPOINT
      prompt: "Please provide the Proxy URI endpoint"
      private: no
      default: "/notarget"

    - name: PROXY_IP
      prompt: "Please provide the Proxy IP Address (for use with curl --resolve)"
      private: no
  #     default: "{{ INGRESS_IP }}"

    - name: PROXY_PORT
      prompt: "Please provide the API Proxy IP Port"
      private: no
      default: "443"

  # vars: 
  #   PROXY_URI_ENDPOINT: "/notarget"   
  #   PROXY_IP: "{{ INGRESS_IP }}"
  #   PROXY_PORT: 443   

  tasks:
    - name: Validate IP and Port Access
      wait_for:
        host: "{{ PROXY_IP }}"
        port: "{{ PROXY_PORT }}"
        state: present
        timeout: 2
    
    - name: Validate TLS handshake
      shell: |
        openssl s_client -connect {{ INGRESS_IP }}:{{ PROXY_PORT }} -servername  {{ DOMAIN_NAME }}

    - name: Proxy invocation using --resolve to test TLS connection
      shell: |
        curl -v -H "Host: {{ DOMAIN_NAME }}" --resolve {{ DOMAIN_NAME }}:{{ PROXY_PORT }}:{{ INGRESS_IP }} https://{{ DOMAIN_NAME }}{{ PROXY_URI_ENDPOINT }}
      args: 
        warn: false        
        

      