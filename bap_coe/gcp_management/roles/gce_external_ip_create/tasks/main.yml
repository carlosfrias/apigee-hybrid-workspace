---
# tasks file for gce_network_create
- name: Assert PROJECT_ID provided
  assert:
    that:
    - PROJECT_ID is defined
    msg: "Please provide PROJECT_ID"

- name: Assert CLUSTER_NAME provided
  assert:
    that:
    - CLUSTER_NAME is defined
    msg: "Please provide CLUSTER_NAME"

- name: Assert GCP_CLOUD_DNS_DESCRIPTION provided
  assert:
    that:
    - GCP_CLOUD_DNS_DESCRIPTION is defined
    msg: "Please provide GCP_CLOUD_DNS_DESCRIPTION"

- name: Set cloud dns cache
  set_fact:
    cacheable: yes
    EXTERNAL_IP_DESCRIPION: "{{ EXTERNAL_IP_DESCRIPION | default(DEFAULT_EXTERNAL_IP_DESCRIPION) }}"
    EXTERNAL_IP_NAME: "external-ip-apigee-ingress-for-{{ CLUSTER_NAME }}"
    GCP_CLOUD_DNS_DESCRIPTION: "{{ GCP_CLOUD_DNS_DESCRIPTION | default(DEFAULT_GCP_CLOUD_DNS_DESCRIPTION) }}"

- name: Create External IP
  shell: |
    gcloud compute addresses create {{ EXTERNAL_IP_NAME }} \
      --project="{{ PROJECT_ID }}" \
      --description="{{ EXTERNAL_IP_DESCRIPION }}" \
      --region={{ GCP_REGION }}
  register: status
  failed_when:
  - status.rc == 1
  - "'already exists' not in status.stderr"


