---
# tasks file for gce_bastion_client_ssh_config
- name: Assert bastion_host_name is defined
  assert:
    that:
      - bastion_host_name is defined
    msg: "Please provide the bastion_host_name"

- name: Assert bastion_host_ip is defined
  assert:
    that:
      - bastion_host_ip is defined
    msg: "Please provide the bastion_host_ip"

- name: Assert bastion_host_user is defined
  assert:
    that:
      - bastion_host_user is defined
    msg: "Please provide the bastion_host_user"

- name: Assert bastion_host_private_key is defined
  assert:
    that:
      - bastion_host_private_key is defined
    msg: "Please provide the bastion_host_private_key"

#- name: Update SSH Config with Bastion Configuration
#  blockinfile:
#    path: ~/.ssh/config
#    create: yes
#    backup: yes
#    mode: 0600
#    marker: "# {mark} ANSIBLE MANAGED BLOCK"
#    marker_begin: "{{ marker_begin }}"
#    marker_end: "{{ marker_end }}"
#    block: |
#      Host {{ bastion_host_name }}
#        Hostname {{ bastion_host_ip }}
#        User {{ bastion_host_user }}
#        IdentityFile "{{ bastion_host_private_key | default('~/.ssh/id_rsa') }}"
#        ControlMaster auto
#        ControlPath ~/.ssh/ansible-%r@%h:%p
#        ControlPersist 5m

- name: Update SSH Config with ProxyCommand to Bastion Configuration
  blockinfile:
    path: ~/.ssh/config
    create: yes
    backup: yes
    mode: 0600
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
    marker_begin: "{{ marker_begin }}"
    marker_end: "{{ marker_end }}"
    block: |
      Host {{ bastion_target_host_range }}
        ProxyCommand ssh -W %h:%p {{ bastion_host_name }}
        IdentityFile "{{ bastion_protected_private_key | default('~/.ssh/id_rsa') }}"

      Host {{ bastion_host_name }}
        Hostname {{ bastion_host_ip }}
        User {{ bastion_host_user }}
        IdentityFile "{{ bastion_host_private_key | default('~/.ssh/id_rsa') }}"
        ControlMaster auto
        ControlPath ~/.ssh/ansible-%r@%h:%p
        ControlPersist 5m