---
# tasks file for gce_firewall_create
- name: Assert we have firewall_ports
  assert:
    that:
      - firewall_ports is defined
    msg: "Please provide the collection of firewall_ports"

- name: create firewall rule
  google.cloud.gcp_compute_firewall:
    name: "{{ VPC_NETWORK_INFO.name | default('default') }}-{{ item.port_name_suffix }}"
    target_tags: "{{ VPC_NETWORK_INFO.name | default('default') }}-firewall-{{ item.port_name_suffix }}"
    project: "{{ PROJECT_ID }}"
    auth_kind: "{{ AUTHORIZATION_KIND | default('serviceaccount') }}"
    service_account_file: "{{ SERVICE_ACCOUNT_FILE_PATH }}"
    state: present
    network: "{{ VPC_NETWORK_INFO }}"
    scopes: "{{ SCOPE_COMPUTE }}"
    allowed:
      - { ip_protocol: "tcp", ports: "{{ item.ports }}" }
  with_items: "{{ firewall_ports }}"
