---
# tasks file for gcp_resource_manager_folders_delete
- name: Assert that ORG_ID is available
  assert:
    that:
    - ORG_ID is defined
    msg: "Please provide ORG_ID collection with list of constraints to no longer enforce."

- name: Assert that the FOLDER_DISPLAY_NAME is available
  assert:
    that:
    - FOLDER_DISPLAY_NAME is defined
    msg: "Please provide the FOLDER_DISPLAY_NAME"

- name: Assert that the GCLOUD_ACCOUNT_EMAIL is available
  assert:
    that:
    - GCLOUD_ACCOUNT_EMAIL is defined
    msg: "Please provide the GCLOUD_ACCOUNT_EMAIL"

- name: List organization folders
  shell: gcloud resource-manager folders list --organization {{ ORG_ID }} --format json
  register: ORG_FOLDERS_LIST

- name: Format response into JSON object
  set_fact:
    ORG_FOLDERS: "{{ ORG_FOLDERS_LIST.stdout | from_json }}"

- name: Find target folder
  set_fact:
    target_folder: "{{ item.name | split('/')[1] }}"
  with_items: "{{ ORG_FOLDERS }}"
  when: item.displayName is search(FOLDER_DISPLAY_NAME)

- name: Show target folder
  debug:
    var: target_folder

- name: Create organization folder
  shell: |
    gcloud beta resource-manager \
    folders delete \
    --folder {{ target_folder }} \
    --account {{ GCLOUD_ACCOUNT_ADMIN_EMAIL }}
  register: FOLDER_CREATE_STATUS

- name: Folder create status output
  debug:
    var: FOLDER_CREATE_STATUS


