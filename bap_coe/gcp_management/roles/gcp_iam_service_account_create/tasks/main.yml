---
# tasks file for gcp_iam_service_account_create
- name: Assert that the GCLOUD_ACCOUNT_EMAIL is available
  assert:
    that:
      - GCLOUD_ACCOUNT_EMAIL is defined
    msg: "Please provide the GCLOUD_ACCOUNT_EMAIL"

- name: Assert that the GCLOUD_ACCOUNT_USER is available
  assert:
    that:
      - GCLOUD_ACCOUNT_USER is defined
    msg: "Please provide the GCLOUD_ACCOUNT_USER"

- name: Assert that the PROJECT_ID is available
  assert:
    that:
      - PROJECT_ID is defined
    msg: "Please provide the PROJECT_ID"

- name: Query for ACTIVE projects list
  shell: gcloud projects list --account {{ GCLOUD_ACCOUNT_EMAIL }} --filter='lifecycleState:ACTIVE'
  register: ACTIVE_PROJECTS

- name: Assert project ACTIVE state
  set_fact:
    cacheable: true
    PROJECT_ACTIVE: "{{ ACTIVE_PROJECTS.stdout is search(PROJECT_ID) | default(false) }}"

- block:
  - name: Create an initial service account
    shell: |
      gcloud iam service-accounts create {{ SERVICE_ACCOUNT_NAME }} \
        --description={{ SERVICE_ACCOUNT_NAME }} \
        --display-name={{ SERVICE_ACCOUNT_NAME }} \
        --project {{ PROJECT_ID }}
    when: PROJECT_ACTIVE is truthy

  rescue:
    - name: RESCUE - Create an initial service account, rescue for idempotency
      shell: |
        gcloud iam service-accounts create {{ SERVICE_ACCOUNT_NAME }} \
          --description={{ SERVICE_ACCOUNT_NAME }} \
          --display-name={{ SERVICE_ACCOUNT_NAME }} \
          --project {{ PROJECT_ID }} \
          --account {{ GCLOUD_ACCOUNT_ADMIN_EMAIL }}
      register: status
      when: PROJECT_ACTIVE is truthy
      failed_when:
        - status.rc == 1
        - "'already exists' not in status.stderr"

    - name: Fail if service is disabled
      fail:
        msg: "Service is disabled"
      when: status.err exists and status.err is search("SERVICE DISABLED")

- name: Wait for the policy bindings to propagate
  pause:
    seconds: "{{ TIME_TO_PROPAGATE_BINDINGS  | default(10) }}"
    prompt: "Wait for the policy bindings to propagate"
  when: PROJECT_ACTIVE is truthy

- name: Assert no service account created on condition
  debug:
    msg: "No service account can be created when there is no project"
  when: PROJECT_ACTIVE is falsy
