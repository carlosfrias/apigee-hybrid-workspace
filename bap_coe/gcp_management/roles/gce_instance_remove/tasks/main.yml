---
# tasks file for gce_instance_remove
- name: Setup GCP Attributes from service account file
  include_role:
    name: service_account_file_processing

- name: Capture start if available
  set_fact:
    start_pos: "{{ INSTANCE_COUNT_START | default(1) }}"

- block:
  - name: remove an instance
    gcp_compute_instance:
      name: "{{ NAME_INSTANCE_PREFIX }}-{{ sequence | default(start_pos) }}"
      state: absent
      zone: "{{ GCP_ZONE }}"
      project: "{{ PROJECT_ID }}"
      auth_kind: "{{ AUTHORIZATION_KIND | default('serviceaccount') }}"
      service_account_file: "{{ SERVICE_ACCOUNT_FILE }}"
      scopes:
        - "{{ SCOPE_COMPUTE }}"
    poll: 0
    async: 300

  rescue:
    - name: Rescue message
      debug:
        msg: "Remove failed for some reason but we will move on to remove the next instance"