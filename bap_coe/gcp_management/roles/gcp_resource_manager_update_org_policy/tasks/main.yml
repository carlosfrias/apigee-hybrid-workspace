---
# tasks file for gcp_CONSTRAINTS_DISABLE_ENFORCEMENT
- name: Assert that UPDATE_ORG_POLICIES list is available
  assert:
    that:
    - UPDATE_ORG_POLICIES is defined
    msg: "Please provide UPDATE_ORG_POLICIES collection with list of constraints to no longer enforce."

- name: Assert that the PROJECT_ID is available
  assert:
    that:
    - PROJECT_ID is defined
    msg: "Please provide the PROJECT_ID"

- name: Assert that the GCLOUD_ACCOUNT_EMAIL is available
  assert:
    that:
    - GCLOUD_ACCOUNT_EMAIL is defined
    msg: "Please provide the GCLOUD_ACCOUNT_EMAIL"

- name: Assert that the WORK_DIR is available
  assert:
    that:
    - WORK_DIR is defined
    msg: "Please provide the WORK_DIR"

- name: Create policy update file
  set_fact:
    cacheable: True
    UPDATE_POLICY_FILE_PATH: "{{ WORK_DIR }}/update_policy.yaml"

- name: Create policy update file
  template:
    src: update_policy.yaml.j2
    dest: "{{ UPDATE_POLICY_FILE_PATH }}"

- name: Update Org Policy
  shell: |
    gcloud resource-manager \
    org-policies set-policy {{ UPDATE_POLICY_FILE_PATH }} \
    --project {{ PROJECT_ID }} \
    --account {{ GCLOUD_ACCOUNT_BILLING_ADMIN_EMAIL }}

- name: Wait for the policy bindings to propagate
  pause:
    seconds: "{{ TIME_TO_PROPAGATE_BINDINGS | default(10) }}"
    prompt: "Wait for the policy bindings to propagate"
