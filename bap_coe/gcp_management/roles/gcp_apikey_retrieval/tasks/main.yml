---
- name: Enable apikeys service
  shell: gcloud services enable apikeys.googleapis.com --project {{ PROJECT_ID }}

- name: Grant role roles/serviceusage.apiKeysAdmin to Admin Service Account
  shell: gcloud projects add-iam-policy-binding {{ PROJECT_ID }} --member="serviceAccount:{{ ADMIN_SERVICE_ACCOUNT }}" --role=roles/serviceusage.apiKeysAdmin

- name: Download API Keys
  uri:
    url: https://apikeys.googleapis.com/v2/projects/{{ PROJECT_ID }}/locations/global/keys
    headers:
      Authorization: Bearer {{ GCLOUD_TOKEN }}
  register: apikeys

- name: Store cache
  set_fact:
    cachable: true
    API_KEY: "{{ apikeys.stdout }}"

- name: Store APIKeys
  copy:
    content: "{{ API_KEY }}"
    dest: "{{ GCP_APIKEY_FILE_PATH }}"
