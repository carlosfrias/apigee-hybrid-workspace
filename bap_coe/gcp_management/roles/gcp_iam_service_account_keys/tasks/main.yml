---
# tasks file for roles/gcp_iam_service_account_keys
- name: Assert that the PROJECT_ID is available
  assert:
    that:
    - PROJECT_ID is defined
    msg: "Please provide the PROJECT_ID"

- name: Set service account name
  set_fact:
    cacheable: yes
    SERVICE_ACCOUNT_NAME: "{{ GCLOUD_ACCOUNT_USER }}-{{ GCLOUD_SERVICE_ACCOUNT_SUFFIX | default('service-account') }}"

- name: Set service account FQDN
  set_fact:
    cacheable: yes
    SERVICE_ACCOUNT_FQDN: "{{ SERVICE_ACCOUNT_NAME }}@{{ PROJECT_ID }}.iam.gserviceaccount.com"

- name: Set service account file name
  set_fact:
    cacheable: yes
    SERVICE_ACCOUNT_FILE: "{{ SERVICE_ACCOUNT_NAME }}-{{ SERVICE_ACCOUNT_FILE_SUFFIX }}.json"

- name: Set service account file path
  set_fact:
    cacheable: yes
    SERVICE_ACCOUNT_FILE_PATH: "{{ WORK_DIR }}/{{ SERVICE_ACCOUNT_FILE }}"

- name: Assert work directory
  file:
    path: "{{ WORK_DIR }}"
    state: directory

- name: Create initial service account key file
  shell: |
    gcloud resource-manager \
    org-policies disable-enforce iam.disableServiceAccountKeyCreation \
    --project {{ PROJECT_ID }} \
    --account {{ GCLOUD_ACCOUNT_BILLING_ADMIN_EMAIL }}
    gcloud iam service-accounts keys create {{ SERVICE_ACCOUNT_FILE_PATH }}  \
      --iam-account={{ SERVICE_ACCOUNT_FQDN }} \
      --project {{ PROJECT_ID }}
