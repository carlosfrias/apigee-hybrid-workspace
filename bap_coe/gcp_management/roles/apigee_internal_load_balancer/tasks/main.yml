---
# tasks file for apigee_internal_load_balancer
- name: Assert GCP_REGION is defined
  assert:
    that:
      - GCP_REGION is defined
    msg: "Please provide the GCP_REGION"

- name: Setup GCP Attributes from service account file
  include_role:
    name: service_account_file_processing

- name: Create tempfile
  tempfile:
    state: file
    suffix: temp
  register: tempfile

- name: Save credentials to tempfile
  copy:
    content: "{{ SERVICE_ACCOUNT_FILE_CONTENT }}"
    dest: "{{ tempfile.path }}"

- name: Activate service account
  command: gcloud auth activate-service-account {{ SERVICE_ACCOUNT_EMAIL }} --key-file {{ tempfile.path }}

- name: Remove credentials tempfile
  file:
    path: "{{ tempfile.path }}"
    state: absent
  when: tempfile.path is defined

- name: Get token
  command: gcloud auth print-access-token
  register: GCLOUD_TOKEN

- name: Get ILB IP
  uri:
    url: "{{ APIGEE_API_URI }}/v1/organizations/{{ PROJECT_ID }}/instances/{{ GCP_REGION }}"
    headers:
      Authorization: Bearer {{ GCLOUD_TOKEN.stdout }}
  register: ilb_node

- name: Set ILB IP to cache
  set_fact:
    cacheable: yes
    TARGET_ILB_IP: "{{ ilb_node.json.host }}"
