---
# tasks file for gce_bastion_host_ssh_config
- name: Assert NAME_INSTANCE_PREFIX is defined
  assert:
    that:
      - NAME_INSTANCE_PREFIX is defined
    msg: "Please provide the NAME_INSTANCE_PREFIX"

- name: Assert GCLOUD_ACCOUNT_USER is defined
  assert:
    that:
      - GCLOUD_ACCOUNT_USER is defined
    msg: "Please provide the GCLOUD_ACCOUNT_USER"

- name: Assert PROJECT_ID is defined
  assert:
    that:
      - PROJECT_ID is defined
    msg: "Please provide the PROJECT_ID"

- name: Assert AUTHORIZATION_KIND is defined
  assert:
    that:
      - AUTHORIZATION_KIND is defined
    msg: "Please provide the AUTHORIZATION_KIND"

- name: Assert SERVICE_ACCOUNT_FILE_PATH is defined
  assert:
    that:
      - SERVICE_ACCOUNT_FILE_PATH is defined
    msg: "Please provide the SERVICE_ACCOUNT_FILE_PATH"

- name: Assert GCP_ZONE is defined
  assert:
    that:
      - GCP_ZONE is defined
    msg: "Please provide the GCP_ZONE"

- name: Load instance info
  command: gcloud compute instances list --format yaml --project {{ PROJECT_ID }} --filter "name = {{ NAME_INSTANCE_PREFIX }}-1"
  register: instance_info

- name: Capture data as string
  set_fact:
    instance_info: "{{ instance_info.stdout }}"

- name: Remove '---'
  set_fact:
    instance_info: "{{ instance_info | split('---') }}"

- name: Convert to yaml
  set_fact:
    instance_info: "{{ instance_info | from_yaml }}"

- name: Show instance_info
  debug:
    msg: "{{ instance_info }}"

- block:
  - name: Extract external IP address
    set_fact:
      bastion_host_ip: "{{ instance_info.networkInterfaces[0].accessConfigs[0].natIP }}"

- name: Update SSH Config with ProxyCommand and Bastion Host Configuration
  blockinfile:
    path: ~/.ssh/config
    create: yes
    backup: yes
    mode: 0600
    marker: "# {mark} {{ NAME_INSTANCE_PREFIX }}* ANSIBLE MANAGED BLOCK"
    marker_begin: "{{ marker_begin }}"
    marker_end: "{{ marker_end }}"
    block: |
      {{ bastion_host_config }}
    notify: "refresh gcp compute ssh config"

# Match host DESTINATION
#  ProxyCommand /usr/bin/trumpssh --user=%r --host=%h --port=%p --notls --fdpass --proxy localhost --proxy_ports 9558
#  ProxyUseFdpass yes
