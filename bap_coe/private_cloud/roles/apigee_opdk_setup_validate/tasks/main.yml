---
# tasks file for apigee-opdk-setup-validate
- name: Assert validate attributes
  assert:
    that:
    - confirm_delete_org is defined
    - interface_name is defined
    - opdk_mp_pod is defined
    - opdk_user_email is defined
    - opdk_user_pass is defined
    - groups['dc_1'] is defined
    - ms_port is defined
    - mp_ext_mgmt_port is defined
    - region is defined
    - apigee_validate_config_file is defined

- name: Update cache
  set_fact:
    cacheable: true
    apigee_validate_config_file: "{{ apigee_validate_config_file }}"

- name: Install Apigee Validate
  shell: '/opt/apigee/apigee-service/bin/apigee-service apigee-validate install'

- name: Create apigee-validate configuration file for RMP
  become: true
  template:
    src: apigee-validate-rmp.conf.j2
    dest: '{{ apigee_validate_config_file }}'
    owner: '{{ opdk_user_name }}'
    group: '{{ opdk_group_name }}'
    force: yes
  when: groups['rmp'] is defined or groups['aio'] is defined 

- name: Create apigee-validate.conf file for Router separate from MP
  become: true
  template:
    src: apigee-validate-r-mp.conf.j2
    dest: '{{ apigee_validate_config_file }}'
    owner: '{{ opdk_user_name }}'
    group: '{{ opdk_group_name }}'
    force: yes
  when: groups['r'] is defined and groups['mp']

#- name: Construct the local Edge response file path
#  set_fact:
#    cacheable: yes
#    local_response_file_path: "{{ local_apigee_secure_path }}/{{ apigee_validate_config_file | basename }}"
#
#- name: Create Local Response File Folder
#  become: yes
#  file:
#    path: "{{ local_apigee_secure_path }}"
#    state: directory
#
#
#- name: Copy response file to target
#  become: yes
#  copy:
#    src: '{{ local_response_file_path }}'
#    dest: "{{ target_response_file_path }}"
#    owner: '{{ opdk_user_name }}'
#    group: '{{ opdk_group_name }}'
#    mode: 777
#    backup: yes
#    force: yes
#  when: manual_response_file is defined
#
#- name: Assert Permissions are Correct
#  become: yes
#  file:
#    path: "{{ target_response_file_path | dirname }}"
#    recurse: yes
#    mode: "777"
#    owner: '{{ opdk_user_name }}'
#    group: '{{ opdk_group_name }}'

- name: Validate OPDK Installation
  shell: '/opt/apigee/apigee-service/bin/apigee-service apigee-validate setup -f {{ apigee_validate_config_file }}'
  environment:
    http_proxy: "{{ http_proxy | default('') }}"
    https_proxy: "{{ https_proxy | default('') }}"
    no_proxy: "{{ no_proxy | default('') }}"

