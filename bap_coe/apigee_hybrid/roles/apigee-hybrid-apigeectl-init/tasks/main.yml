---
# tasks file for roles/apigee-hybrid-apigeectl-apply
- name: Set container context
  shell: kubectl config current-context

- block:
  - name: Invoke init command
    shell: ./apigeectl init -f {{ OVERRIDE_FILE }}
    args:
      chdir: "{{ APIGEECTL_DIR }}"

  rescue:
  - name: Wait 1 minute before doing init again
    pause:
      prompt: "Wait {{ APIGEECTL_CMD_TIMEOUT | default(60) }} seconds before doing init again"
      seconds: "{{ APIGEECTL_CMD_TIMEOUT | default(60) }}"

  - name: Invoke init command
    shell: ./apigeectl init -f {{ OVERRIDE_FILE }}
    args:
      chdir: "{{ APIGEECTL_DIR }}"

- name: apigeectl init needs a few seconds to complete
  pause:
    prompt: "apigeectl init needs a few seconds to complete"
    seconds: "{{ APIGEECTL_CMD_TIMEOUT | default(60) }}"
