---
# tasks file for roles/apigee-hybrid-apigeectl-configure

- name: Obtain PROJECT_NUMBER
  shell: gcloud projects describe {{ PROJECT_ID }} --format="value(projectNumber)"
  register: project_number

- name: Load ENV Group
  import_role:
    name: apigee-hybrid-group-create

- name: Load TLS certs
  import_role:
    name: apigee-hybrid-tls-certs-create

- name: Set attributes in cache
  set_fact: 
    cacheable: yes
    PROJECT_NUMBER: "{{ project_number.stdout }}"
    KMS_ENCRYPTION_KEY: "{{ KMS_ENCRYPTION_KEY | default(DEFAULT_KMS_ENCRYPTION_KEY) }}"
    KVM_ENCRYPTION_KEY: "{{ KVM_ENCRYPTION_KEY | default(DEFAULT_KVM_ENCRYPTION_KEY) }}"
    CACHE_ENCRYPTION_KEY: "{{ CACHE_ENCRYPTION_KEY | default(DEFAULT_CACHE_ENCRYPTION_KEY) }}"
    RUNTIME_RESOURCES_REQUESTS_CPU: "{{ RUNTIME_RESOURCES_REQUESTS_CPU | default(DEFAULT_RUNTIME_RESOURCES_REQUESTS_CPU) }}"
    RUNTIME_RESOURCES_REQUESTS_MEMORY: "{{ RUNTIME_RESOURCES_REQUESTS_MEMORY | default(DEFAULT_RUNTIME_RESOURCES_REQUESTS_MEMORY) }}"
    CASSANDRA_REPLICA_COUNT: "{{ CASSANDRA_REPLICA_COUNT | default(DEFAULT_CASSANDRA_REPLICA_COUNT) }}"
    CASSANDRA_RESOURCES_REQUESTS_CPU: "{{ CASSANDRA_RESOURCES_REQUESTS_CPU | default(DEFAULT_CASSANDRA_RESOURCES_REQUESTS_CPU) }}"
    CASSANDRA_RESOURCES_REQUESTS_MEMORY: "{{ CASSANDRA_RESOURCES_REQUESTS_MEMORY | default(DEFAULT_CASSANDRA_RESOURCES_REQUESTS_MEMORY) }}"
    CASSANDRA_MAX_HEAP_SIZE: "{{ CASSANDRA_MAX_HEAP_SIZE | default(DEFAULT_CASSANDRA_MAX_HEAP_SIZE) }}"
    CASSANDRA_HEAP_NEW_SIZE: "{{ CASSANDRA_HEAP_NEW_SIZE | default(DEFAULT_CASSANDRA_HEAP_NEW_SIZE) }}"
    CASSANDRA_STORAGE_STORAGECLASS: "{{ CASSANDRA_STORAGE_STORAGECLASS | default(DEFAULT_CASSANDRA_STORAGE_STORAGECLASS) }}"
    CASSANDRA_STORAGE_CAPACITY: "{{ CASSANDRA_STORAGE_CAPACITY | default(DEFAULT_CASSANDRA_STORAGE_CAPACITY) }}"
    SYNCHRONIZER_REPLICA_COUNT_MIN: "{{ SYNCHRONIZER_REPLICA_COUNT_MIN | default(DEFAULT_SYNCHRONIZER_REPLICA_COUNT_MIN) }}"
    RUNTIME_REPLICA_COUNT_MIN: "{{ RUNTIME_REPLICA_COUNT_MIN | default(DEFAULT_RUNTIME_REPLICA_COUNT_MIN) }}"
    RUNTIME_REPLICA_COUNT_MAX: "{{ RUNTIME_REPLICA_COUNT_MAX | default(DEFAULT_RUNTIME_REPLICA_COUNT_MAX) }}"
    CASSANDRA_AUTH_DEFAULT_PASSWORD: "{{ CASSANDRA_AUTH_DEFAULT_PASSWORD | default(DEFAULT_CASSANDRA_AUTH_DEFAULT_PASSWORD) }}"
    CASSANDRA_AUTH_ADMIN_PASSWORD: "{{ CASSANDRA_AUTH_ADMIN_PASSWORD | default(DEFAULT_CASSANDRA_AUTH_ADMIN_PASSWORD) }}"
    CASSANDRA_AUTH_DDL_PASSWORD: "{{ CASSANDRA_AUTH_DDL_PASSWORD | default(DEFAULT_CASSANDRA_AUTH_DDL_PASSWORD) }}"
    CASSANDRA_AUTH_DML_PASSWORD: "{{ CASSANDRA_AUTH_DML_PASSWORD | default(DEFAULT_CASSANDRA_AUTH_DML_PASSWORD) }}"
    UDCA_REPLICA_COUNT_MIN: "{{ UDCA_REPLICA_COUNT_MIN | default(DEFAULT_UDCA_REPLICA_COUNT_MIN) }}"
    UDCA_REPLICA_COUNT_MAX: "{{ UDCA_REPLICA_COUNT_MAX | default(DEFAULT_UDCA_REPLICA_COUNT_MAX) }}"
    UDCA_RESOURCES_REQUESTS_CPU: "{{ UDCA_RESOURCES_REQUESTS_CPU | default(DEFAULT_UDCA_RESOURCES_REQUESTS_CPU) }}"
    UDCA_RESOURCES_REQUESTS_MEMORY: "{{ UDCA_RESOURCES_REQUESTS_MEMORY | default(DEFAULT_UDCA_RESOURCES_REQUESTS_MEMORY) }}"
    MART_REPLICA_COUNT_MIN: "{{ MART_REPLICA_COUNT_MIN | default(DEFAULT_MART_REPLICA_COUNT_MIN) }}"
    MART_REPLICA_COUNT_MAX: "{{ MART_REPLICA_COUNT_MAX | default(DEFAULT_MART_REPLICA_COUNT_MAX) }}"
    MART_RESOURCES_REQUESTS_CPU: "{{ MART_RESOURCES_REQUESTS_CPU | default(DEFAULT_MART_RESOURCES_REQUESTS_CPU) }}"
    MART_RESOURCES_REQUESTS_MEMORY: "{{ MART_RESOURCES_REQUESTS_MEMORY | default(DEFAULT_MART_RESOURCES_REQUESTS_MEMORY) }}"
    CONNECT_AGENT_REPLICA_COUNT_MIN: "{{ CONNECT_AGENT_REPLICA_COUNT_MIN | default(DEFAULT_CONNECT_AGENT_REPLICA_COUNT_MIN) }}"

- name: Generate overrides.yml
  template: 
    src: overrides-{{ APIGEE_OVERRIDE_TEMPLATE | default('non-prod') }}.yaml
    dest: "{{ OVERRIDE_FILE }}"

