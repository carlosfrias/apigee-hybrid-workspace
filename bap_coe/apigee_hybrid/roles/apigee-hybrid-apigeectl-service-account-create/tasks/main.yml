---
# tasks file for roles/apigee-hybrid-apigeectl-service-account-create
- name: Set default project
  shell: gcloud config set project {{ PROJECT_ID }}

- name: Cache any updates to the service account list using SERVICE_ACCOUNTS
  set_fact:
    cacheable: yes
    SERVICE_ACCOUNTS: "{{ SERVICE_ACCOUNTS | default(DEFAULT_SERVICE_ACCOUNTS) }}"
    SERVICE_ACCOUNT_ADMIN: "{{ SERVICE_ACCOUNT_ADMIN | default(DEFAULT_SERVICE_ACCOUNT_ADMIN) }}"

- name: Create an initial service account
  shell: |
    gcloud iam service-accounts create {{ APIGEE_NON_PROD_USER }} \
      --description={{ APIGEE_NON_PROD_USER }} \
      --display-name={{ APIGEE_NON_PROD_USER }} \
      --project {{ PROJECT_ID }}
  register: status
  failed_when:
  - status.rc == 1
  - "'already exists' not in status.stderr"

- name: Modify IAM roles for {{ APIGEE_NON_PROD_USER }}
  ignore_errors: "{{ IGNORE_ERRORS | default(False) }}"
  shell: |
    gcloud projects add-iam-policy-binding {{ PROJECT_ID }} \
      --member {{ ACCOUNT_TYPE }}:{{ APIGEE_NON_PROD_USER }} \
      --role={{ item }} \
      --account={{ GCLOUD_ACCOUNT_PROJECT_ADMIN_EMAIL }}
  with_items: "{{ APIGEE_NON_PROD_ROLES }}"

- name: Wait for the policy bindings to propagate
  pause:
    seconds: "{{ TIME_TO_PROPAGATE_BINDINGS  | default(10) }}"
    prompt: "Wait for the policy bindings to propagate"



- name: Create Service Accounts
  shell: echo 'y' | ./tools/create-service-account {{ item }} --dir {{ SERVICE_ACCOUNTS_DIR }} --env {{ SERVICE_ACCOUNT_SCOPE }}
  args:
    chdir: "{{ HYBRID_FILES_DIR }}"
  with_items: "{{ SERVICE_ACCOUNTS }}"

- name: Create apigee-org-admin service account
  shell: |
    gcloud iam service-accounts create apigee-org-admin \
    --project={{ PROJECT_ID }} \
    --display-name=apigee-org-admin \
    --account {{ GCLOUD_ACCOUNT_EMAIL }}
  register: status
  failed_when:
    - status.rc == 1
    - "'already exists' not in status.stdout"
    - "'already exists' not in status.stderr"

- name: Assign apigee admin role to apigee-org-admin
  shell: gcloud projects add-iam-policy-binding {{ PROJECT_ID }} \
          --member serviceAccount:apigee-org-admin@{{ PROJECT_ID }}.iam.gserviceaccount.com \
          --role roles/apigee.admin \
          --account {{ GCLOUD_ACCOUNT_EMAIL }}
