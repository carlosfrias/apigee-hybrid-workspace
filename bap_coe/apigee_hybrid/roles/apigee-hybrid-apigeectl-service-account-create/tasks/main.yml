---
# tasks file for roles/apigee-hybrid-apigeectl-service-account-create
- name: Set default project
  shell: gcloud config set project {{ PROJECT_ID }}

- name: Service account list updates
  set_fact:
    cacheable: yes
    SERVICE_ACCOUNTS: "{{ SERVICE_ACCOUNTS | default(DEFAULT_SERVICE_ACCOUNTS) }}"
    SERVICE_ACCOUNT_ADMIN: "{{ SERVICE_ACCOUNT_ADMIN | default(DEFAULT_SERVICE_ACCOUNT_ADMIN) }}"

- name: Create Service Accounts
  shell: echo 'y' | ./tools/create-service-account {{ item }} ./service-accounts
  args:
    chdir: "{{ HYBRID_FILES }}"
  with_items: "{{ SERVICE_ACCOUNTS }}"

- name: Assign apigee-org-admin role
  shell: gcloud projects add-iam-policy-binding {{ PROJECT_ID }} \
          --member serviceAccount:{{ SERVICE_ACCOUNT_ADMIN }}@{{ PROJECT_ID }}.iam.gserviceaccount.com \
          --role roles/apigee.admin
  when: APIGEE_VERSION is version_compare('1.4', '<') and (SERVICE_ACCOUNT_ADMIN | trim | length )> 0
