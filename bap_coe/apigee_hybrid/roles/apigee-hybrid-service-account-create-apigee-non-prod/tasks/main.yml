---
# tasks file for roles/apigee-non-prod
- name: Set default project
  shell: gcloud config set project {{ PROJECT_ID }}

- name: Cache any updates to the service account list using SERVICE_ACCOUNTS
  set_fact:
    cacheable: yes
    SERVICE_ACCOUNTS: "{{ SERVICE_ACCOUNTS | default(DEFAULT_SERVICE_ACCOUNTS) }}"

- name: Create an initial service account
  shell: |
    gcloud iam service-accounts create {{ APIGEE_NON_PROD_USER }} \
      --description={{ APIGEE_NON_PROD_USER }} \
      --display-name={{ APIGEE_NON_PROD_USER }} \
      --project {{ PROJECT_ID }}
  register: status
  failed_when:
  - status.rc == 1
  - "'already exists' not in status.stderr"

- name: Modify IAM roles for {{ APIGEE_NON_PROD_USER }}
  ignore_errors: "{{ IGNORE_ERRORS | default(False) }}"
  shell: |
    gcloud projects add-iam-policy-binding {{ PROJECT_ID }} \
      --member serviceAccount:{{ APIGEE_NON_PROD_EMAIL }} \
      --role={{ item }} \
      --account={{ ADMIN_ACCOUNT_EMAIL }}
  with_items: "{{ APIGEE_NON_PROD_ROLES }}"

- name: Wait for the policy bindings to propagate
  pause:
    seconds: "{{ TIME_TO_PROPAGATE_BINDINGS  | default(10) }}"
    prompt: "Wait for the policy bindings to propagate"

- name: Assert target folder is available
  file:
    path: "{{ HYBRID_FILES_DIR }}/service-accounts"
    mode: 0755
    state: directory

- name: Create apigee-non-prod service account key file
  shell: |
    gcloud iam service-accounts keys create {{ HYBRID_FILES_DIR }}/service-accounts/{{ PROJECT_ID }}-apigee-non-prod.json \
      --iam-account={{ APIGEE_NON_PROD_EMAIL }} \
      --project {{ PROJECT_ID }} \
      --account {{ ADMIN_SERVICE_ACCOUNT_EMAIL }}

- name: Create Service Accounts
  shell: echo 'y' | ./tools/create-service-account --dir {{ SERVICE_ACCOUNTS_DIR }} --env {{ SERVICE_ACCOUNT_SCOPE }}
  args:
    chdir: "{{ HYBRID_FILES_DIR }}"

- name: Create APIGEE_ADMIN service account
  shell: |
    gcloud iam service-accounts create {{ APIGEE_ADMIN }} \
    --project={{ PROJECT_ID }} \
    --display-name={{ APIGEE_ADMIN }} \
    --account {{ ADMIN_ACCOUNT_EMAIL }}
  register: status
  failed_when:
    - status.rc == 1
    - "'already exists' not in status.stdout"
    - "'already exists' not in status.stderr"

- name: Assign apigee admin role to APIGEE_ADMIN
  shell: gcloud projects add-iam-policy-binding {{ PROJECT_ID }} \
          --member serviceAccount:{{ APIGEE_ADMIN }}@{{ PROJECT_ID }}.iam.gserviceaccount.com \
          --role roles/apigee.admin \
          --account {{ ADMIN_ACCOUNT_EMAIL }}
