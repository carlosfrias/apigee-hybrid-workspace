---
# tasks file for roles/apigee-hybrid-gke-create
- name: Set gke cache
  set_fact:
    cacheable: yes
    ATTACHED_CLUSTER: False
    NODE_COUNT: "{{ NODE_COUNT | default(DEFAULT_NODE_COUNT) }}"
    NODE_SIZE: "{{ NODE_SIZE | default(DEFAULT_NODE_SIZE) }}"
    GCLOUD_SERVICE_ACCOUNT_NAME: "{{ GCLOUD_SERVICE_ACCOUNT_NAME | default(DEFAULT_SERVICE_ACCOUNT_NAME) }}"

- name: Set gke cache
  set_fact:
    cacheable: yes
    SERVICE_ACCOUNT_KEY_PATH: "{{ WORK_DIR }}/{{ GCLOUD_SERVICE_ACCOUNT_NAME }}-service-account-credentials.json"

- name: Set KUBECONFIG cache
  set_fact:
    cacheable: yes
    FQ_CLUSTER_NAME: "gke_{{ PROJECT_ID }}_{{  CLUSTER_ZONE }}_{{ CLUSTER_NAME }}"
    CLUSTER_KUBECONFIG: "{{ WORK_DIR }}/{{ CLUSTER_NAME }}-{{ CLUSTER_ZONE }}.context.json"

- name: Confirm WORK_DIR
  file: 
    path: "{{ WORK_DIR }}"
    state: directory  

- name: Set default project
  shell: gcloud config set project "{{ PROJECT_ID }}"

- name: Set compute/zone
  shell: gcloud config set compute/zone {{ CLUSTER_ZONE }}

- name: Create gcp cluster
  shell: |
    gcloud container clusters create {{ CLUSTER_NAME }} \
      --zone {{ CLUSTER_ZONE }} \
      --machine-type={{ NODE_SIZE }} \
      --num-nodes={{ NODE_COUNT | int }} \
      --min-nodes={{ (NODE_COUNT | int ) - 1 }} \
      --max-nodes={{ (NODE_COUNT | int ) * 2 }} \
      --subnetwork=default \
      --enable-ip-alias \
      --no-enable-autoupgrade \
      --no-enable-autorepair \
      --enable-autoscaling \
      --project {{ PROJECT_ID }}
  register: status 
  failed_when:  
    - status.rc == 1
    - "'Already exists' not in status.stderr"

- name: Obtain PROJECT_NUMBER
  shell: gcloud projects describe {{ PROJECT_ID }} --format="value(projectNumber)"
  register: project_number

- name: Create ASM service account
  ignore_errors: yes
  shell: gcloud iam service-accounts create {{ GCLOUD_SERVICE_ACCOUNT_NAME }} --project={{ PROJECT_ID }}
  register: status
  failed_when:
    - status.rc == 1
    - "'already exists' not in status.stderr"

- name: Bind gkehub.connect IAM role to service account - this is now in the install_asm bash script
  tags: ['install_asm_skip']
  shell: |
    gcloud projects add-iam-policy-binding {{ PROJECT_ID }} \
     --member="serviceAccount:{{ GCLOUD_SERVICE_ACCOUNT_EMAIL }}" \
     --role="roles/gkehub.connect"

- name: Download service account credential file
  shell: |
    gcloud iam service-accounts keys create {{ SERVICE_ACCOUNT_KEY_PATH }} \
      --iam-account="{{ GCLOUD_SERVICE_ACCOUNT_EMAIL }}"
  args:
    creates: "{{ SERVICE_ACCOUNT_KEY_PATH }}"

- name: Register the cluster - this is now in the install_asm bash script
  shell: |
    gcloud container hub memberships register {{ CLUSTER_NAME }} \
    --gke-cluster={{ CLUSTER_ZONE }}/{{ CLUSTER_NAME }} \
    --service-account-key-file={{ SERVICE_ACCOUNT_KEY_PATH }}
  register: status
  failed_when:
    - status.rc == 1
    - "'already exists' not in status.stderr"

- name: Set workload pool values
  set_fact:
    cacheable: yes
    WORKLOAD_POOL: "{{ PROJECT_ID }}.svc.id.goog"
    PROJECT_NUMBER: "{{ project_number.stdout }}"
    MESH_ID: "proj-{{ PROJECT_NUMBER | default(project_number.stdout) }}"

- name: Set MESH_ID label - this is now in the install_asm bash script
  tags: ['install_asm_skip']
  shell: gcloud container clusters update {{ CLUSTER_NAME }} --update-labels=mesh_id={{ MESH_ID }}

- name: Enable workload identity - this is now in the install_asm bash script
  tags: ['install_asm_skip']
  shell: gcloud container clusters update {{ CLUSTER_NAME }} --workload-pool={{ WORKLOAD_POOL }}

- name: Enable Cloud Monitoring and Cloud Logging in GKE - this is now in the install_asm bash script
  tags: ['install_asm_skip']
  shell: gcloud container clusters update {{ CLUSTER_NAME }}

- block:
  - name: Rename cluster
    shell: |
      kubectx {{ CLUSTER_NAME }}={{ FQ_CLUSTER_NAME }}
      kubectx {{ CLUSTER_NAME }}
  rescue:
    - name: RESCUE - Wait for the cluster...
      pause:
        seconds: 15

    - name: RESCUE - Rename cluster
      shell: |
        kubectx {{ CLUSTER_NAME }}={{ FQ_CLUSTER_NAME }}
        kubectx {{ CLUSTER_NAME }}

- name: Generate kubeconfig file    
  shell: kubectl config view --minify --flatten --context={{ CLUSTER_NAME }} 
  register: kubeconfig_content  

- name: Create kubeconfig file
  copy: 
    content: "{{ kubeconfig_content.stdout }}"
    dest: "{{ CLUSTER_KUBECONFIG }}"     

- name: Ensure you have cluster-admin on the cluster
  ignore_errors: yes
  shell: kubectl create clusterrolebinding user-cluster-admin --clusterrole cluster-admin --user {{ GCLOUD_ACCOUNT | default(GCLOUD_ACCOUNT_USER }}
  failed_when:  
    - status.rc == 1
    - "'already exists' not in status.stderr"
    
- name: Update authentication credentials
  shell: gcloud container clusters get-credentials {{ CLUSTER_NAME }} --zone {{ CLUSTER_ZONE }}
