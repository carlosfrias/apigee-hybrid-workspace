---
- name: Validate that key_value_pair is provided
  fail:
    msg: "Please provide a key_value_pair to update"
  when: key_value_pair is not defined

- name: Validate that key_value_pair.key is provided
  fail:
    msg: "Please provide a key_value_pair.key to update"
  when: key_value_pair.key is not defined

- name: Validate that key_value_pair.value is provided
  fail:
    msg: "Please provide a key_value_pair.value to update"
  when: key_value_pair.value is not defined

- name: Validate that key_value_pair.file_name is provided
  fail:
    msg: "Please provide a key_value_pair.file_name to update"
  when: key_value_pair.file_name is not defined

- name: Update key and value in target file
  replace:
    regexp: '(.*){{ key_value_pair.key }}(\s*){{ key_value_pair.separator }}(\s*)(.*)'
    replace: '\1{{ key_value_pair.key }}\2{{ key_value_pair.separator }}\3{{ key_value_pair.value }}'
    path: "{{ key_value_pair.file_name }}"
  when: key_value_pair.separator | length > 0

- name: Update key only in target file
  replace:
    regexp: '^(.*){{ key_value_pair.key }}(.*)'
    replace: '\1{{ key_value_pair.value }}\2'
    path: "{{ key_value_pair.file_name }}"
  when: key_value_pair.separator | length == 0

- name: Debug regexp
  debug:
    msg: "regexp on lineinfile: '(.*){{ key_value_pair.key }}(\s*){{ key_value_pair.separator }}(\s*)(.*)'"

- pause:
    
- name: Add missing key and value in target file
  lineinfile:
    regexp: '(.*){{ key_value_pair.key }}(\s*){{ key_value_pair.separator }}(\s*)(.*)'
#    search_string: '(.*){{ key_value_pair.key }}(\s*){{ key_value_pair.separator }}(\s*)(.*)'
    line: '{{ key_value_pair.key }} {{ key_value_pair.separator }} {{ key_value_pair.value }}'
    path: "{{ key_value_pair.file_name }}"
#    state: present
    backrefs: yes
    insertafter: EOF
  when: key_value_pair.separator | length > 0
