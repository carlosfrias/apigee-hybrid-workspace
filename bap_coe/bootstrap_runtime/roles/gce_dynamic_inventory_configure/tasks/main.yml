---
# tasks file for gce_dynamic_inventory_configure
# The connection created is the equivalent of gcloud compute ssh — zone “<region>” “ssh-iap” — tunnel-through-iap — project “<project_ID>”
# Google search: `ansible gcloud ssh-iap`
# Used the following sources:
# https://stackoverflow.com/questions/58996471/ansible-gcp-iap-tunnel
# https://binx.io/blog/2021/03/10/how-to-tell-ansible-to-use-gcp-iap-tunneling/
# https://unix.stackexchange.com/questions/545034/with-ansible-is-it-possible-to-connect-connect-to-hosts-that-are-behind-cloud-i

- name: Assert that the GCLOUD_ACCOUNT_USER is available
  assert:
    that:
      - GCLOUD_ACCOUNT_USER is defined
    msg: "Please provide the GCLOUD_ACCOUNT_USER"

- name: Assert SERVICE_ACCOUNT_FILE_PATH
  assert:
    that:
      - SERVICE_ACCOUNT_FILE_PATH
    msg: "Please provide the SERVICE_ACCOUNT_FILE_PATH"

- name: Assert GCP_ZONE
  assert:
    that:
      - GCP_ZONE
    msg: "Please provide the GCP_ZONE"

- name: Assert PROJECT_ID
  assert:
    that:
      - PROJECT_ID
    msg: "Please provide the PROJECT_ID"

- name: Assert INVENTORY_DIR
  assert:
    that:
      - INVENTORY_DIR
    msg: "Please provide the INVENTORY_DIR"

- name: Assert INVENTORY_DIR
  file:
    path: "{{ INVENTORY_DIR }}/group_vars"
    state: directory

- name: Generate config files
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - { src: "gce-dynamic-inventory.gcp.yml.j2", dest: "{{ INVENTORY_DIR }}/{{ PROJECT_ID }}-gce-dynamic-inventory.gcp.yml" }
    - { src: "ansible.cfg.j2", dest: "{{ playbook_dir }}/ansible.cfg.template" }

- name: Update inventory for use of ssh-iap for access
  copy:
    src: "{{ item.src}}"
    dest: "{{ item.dest }}"
  with_items:
    - { src: "group_vars/all.yml", dest: "{{ INVENTORY_DIR }}/group_vars/all.yml" }
    - { src: "gcp-scp-wrapper.sh", dest: "{{ INVENTORY_DIR }}/gcp-scp-wrapper.sh" }
    - { src: "gcp-ssh-wrapper.sh", dest: "{{ INVENTORY_DIR }}/gcp-ssh-wrapper.sh" }

- name: Refresh the inventory
  meta: refresh_inventory

