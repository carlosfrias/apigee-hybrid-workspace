---
- name: Create Apigee hybrid runtime on GCP
  hosts: localhost

  vars_files:
  - ~/.apigee-secure/apigee-hybrid-sensitive-attributes.yml
  - ../resources/attributes.yml

  collections:
  - bap_coe.bootstrap_runtime

  roles:
    - { role: terraform-installer }

  tasks:
  - name: Create mig-l7xlb Apigee X Instance
    terraform:
      project_path: ../../terraform-modules/samples/x-l7xlb
      state: present
      force_init: yes
      variables:
        project_id: "{{ PROJECT_ID }}"
      backend_config:
        ax_region: "europe-west1"
        apigee_environments: ["test1", "test2"]
        apigee_instances:
          euw1-instance:
            region: "europe-west1"
            ip_range: "10.0.0.0/22"
            environments: ["test1", "test2"]
        apigee_envgroups:
          test:
            environments: ["test1", "test2"]
            hostnames: ["test.api.example.com"]
        network: "apigee-network"
        exposure_subnets:
          - {
              name              : "apigee-exposure",
              ip_cidr_range     : "10.100.0.0/24",
              region            : "europe-west1",
              secondary_ip_range: null
            }
        peering_range: "10.0.0.0/22"
        support_range: "10.1.0.0/28"