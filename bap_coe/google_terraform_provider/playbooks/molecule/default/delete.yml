---
- name: Create Apigee runtime on GCP
  hosts: localhost
  connection: local

  vars_files:
  - ~/.apigee-secure/apigee-hybrid-sensitive-attributes.yml
  - attributes.yml

  collections:
  - bap_coe.gcp_management

  roles:
    - { role: gcp_resource_manager_folders_get_folder_id }
    - { role: gcp_project_delete }
    - { role: gcp_resource_manager_folders_delete }

  pre_tasks:
    - name: Assert TERRAFORM_PROJECT_PATH
      stat:
        path: "{{ TERRAFORM_PROJECT_PATH }}"
      register: TERRAFORM_PROJECT_PATH_STATUS

    - block:
      - name: Terraform destroy
        ignore_errors: true
        shell: |
          {{ TERRAFORM_BIN_PATH }} destroy --var-file={{ TERRAFORM_PROJECT_PATH }}/x-demo.tfvars -var "project_id={{ PROJECT_ID }}" -auto-approve
        args:
          chdir: "{{ TERRAFORM_PROJECT_PATH }}"

      - name: Remove downloaded terraform modules
        ignore_errors: true
        file:
          path: ../../terraform-modules
          state: absent

      when: TERRAFORM_PROJECT_PATH_STATUS.stat.exists is truthy


