---
- name: Create Apigee runtime on GCP
  hosts: localhost

  vars_files:
  - ~/.apigee-secure/apigee-hybrid-sensitive-attributes.yml
  - attributes.yml

  collections:
  - bap_coe.bootstrap_runtime
  - bap_coe.gcp_management

  roles:
  - { role: terraform_installer }
  - { role: gcp_project_create }

  tasks:
      - name: Terraform init
        shell: |
          {{ TERRAFORM_BIN_PATH }} init
        args:
          chdir: "{{ TERRAFORM_PROJECT_PATH }}"

      - name: Terraform plan
        shell: |
          {{ TERRAFORM_BIN_PATH }} plan --var-file={{ TERRAFORM_PROJECT_PATH }}/x-demo.tfvars -var "project_id={{ PROJECT_ID }}"
        args:
          chdir: "{{ TERRAFORM_PROJECT_PATH }}"

      - name: Terraform apply
        shell: |
          {{ TERRAFORM_BIN_PATH }} apply --var-file={{ TERRAFORM_PROJECT_PATH }}/x-demo.tfvars -var "project_id={{ PROJECT_ID }}" -auto-approve
        args:
          chdir: "{{ TERRAFORM_PROJECT_PATH }}"

#      - name: Create mig-l7xlb Apigee X Instance
#        terraform:
#          project_path: "{{ TERRAFORM_PROJECT_PATH }}"
#          binary_path: "{{ TERRAFORM_BIN_PATH }}"
#          state: present
#          force_init: yes
#          variables:
#            project_id: "{{ PROJECT_ID }}"
#            ax_region: "europe-west1"
#            network: "apigee-network"
#            peering_range: "10.0.0.0/22"
#            support_range: "10.1.0.0/28"
#            exposure_subnets:
#              - { name: "apigee-exposure", ip_cidr_range: "10.100.0.0/24", region: "europe-west1", secondary_ip_range: null }
#            apigee_environments:
#              - "test1"
#              - "test2"
#            apigee_instances:
#              euw1-instance:
#              region: "europe-west1"
#              ip_range: "10.0.0.0/22"
#              environments:
#              - "test1"
#              - "test2"
#            apigee_envgroups:
#              test:
#              environments:
#              - "test1"
#              - "test2"
#              hostnames:
#              - "test.api.example.com"
